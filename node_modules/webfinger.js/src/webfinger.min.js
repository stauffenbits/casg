/* webfinger.js v2.6.6 | (c) 2012 Nick Jennings | License: AGPL | https://github.com/silverbucket/webfinger.js */
"function"!=typeof fetch&&"function"!=typeof XMLHttpRequest&&(XMLHttpRequest=require("xhr2")),function(t){var f={"http://webfist.org/spec/rel":"webfist","http://webfinger.net/rel/avatar":"avatar",remotestorage:"remotestorage","http://tools.ietf.org/id/draft-dejong-remotestorage":"remotestorage",remoteStorage:"remotestorage","http://www.packetizer.com/rel/share":"share","http://webfinger.net/rel/profile-page":"profile",me:"profile",vcard:"vcard",blog:"blog","http://packetizer.com/rel/blog":"blog","http://schemas.google.com/g/2010#updates-from":"updates","https://camlistore.org/rel/server":"camilstore"},c={avatar:[],remotestorage:[],blog:[],vcard:[],updates:[],share:[],profile:[],webfist:[],camlistore:[]},l=["webfinger","host-meta","host-meta.json"];function p(t){return t.toString=function(){return this.message},t}function e(t){"object"!=typeof t&&(t={}),this.config={tls_only:void 0===t.tls_only||t.tls_only,webfist_fallback:void 0!==t.webfist_fallback&&t.webfist_fallback,uri_fallback:void 0!==t.uri_fallback&&t.uri_fallback,request_timeout:void 0!==t.request_timeout?t.request_timeout:1e4}}e.prototype.__fetchJRD=function(t,e,r){if("function"==typeof fetch)return this.__fetchJRD_fetch(t,e,r);if("function"==typeof XMLHttpRequest)return this.__fetchJRD_XHR(t,e,r);throw new Error("add a polyfill for fetch or XMLHttpRequest")},e.prototype.__fetchJRD_fetch=function(r,e,o){var s,n=this;"function"==typeof AbortController&&(s=new AbortController);var t=fetch(r,{headers:{Accept:"application/jrd+json, application/json"},signal:s?s.signal:void 0}).then(function(t){if(t.ok)return t.text();throw 404===t.status?p({message:"resource not found",url:r,status:t.status}):p({message:"error during request",url:r,status:t.status})},function(t){throw p({message:"error during request",url:r,status:void 0,err:t})}).then(function(t){if(n.__isValidJSON(t))return t;throw p({message:"invalid json",url:r,status:void 0})}),i=new Promise(function(t,e){setTimeout(function(){e(p({message:"request timed out",url:r,status:void 0})),s&&s.abort()},n.config.request_timeout)});Promise.race([t,i]).then(function(t){o(t)}).catch(function(t){e(t)})},e.prototype.__fetchJRD_XHR=function(r,o,s){var n=this,i=!1,a=new XMLHttpRequest;function t(){if(!i){if(i=!0,200===a.status)return n.__isValidJSON(a.responseText)?s(a.responseText):o(p({message:"invalid json",url:r,status:a.status}));if(404===a.status)return o(p({message:"resource not found",url:r,status:a.status}));if(301<=a.status&&a.status<=302){var t=a.getResponseHeader("Location");return"string"==typeof(e=t)&&"https"===e.split("://")[0]?u():o(p({message:"no redirect URL found",url:r,status:a.status}))}return o(p({message:"error during request",url:r,status:a.status}));var e}}function u(){a.onreadystatechange=function(){4===a.readyState&&t()},a.onload=function(){t()},a.ontimeout=function(){return o(p({message:"request timed out",url:r,status:a.status}))},a.open("GET",r,!0),a.timeout=n.config.request_timeout,a.setRequestHeader("Accept","application/jrd+json, application/json"),a.send()}return u()},e.prototype.__isValidJSON=function(t){try{JSON.parse(t)}catch(t){return!1}return!0},e.prototype.__isLocalhost=function(t){return/^localhost(\.localdomain)?(\:[0-9]+)?$/.test(t)},e.prototype.__processJRD=function(t,e,r,o){var s=JSON.parse(e);if("object"!=typeof s||"object"!=typeof s.links)return void 0!==s.error?r(p({message:s.error,request:t})):r(p({message:"unknown response from server",request:t}));var n=s.links;Array.isArray(n)||(n=[]);var i={object:s,json:e,idx:{}};i.idx.properties={name:void 0},i.idx.links=JSON.parse(JSON.stringify(c)),n.map(function(r,t){if(f.hasOwnProperty(r.rel)&&i.idx.links[f[r.rel]]){var o={};Object.keys(r).map(function(t,e){o[t]=r[t]}),i.idx.links[f[r.rel]].push(o)}});var a=JSON.parse(e).properties;for(var u in a)a.hasOwnProperty(u)&&"http://packetizer.com/ns/name"===u&&(i.idx.properties.name=a[u]);return o(i)},e.prototype.lookup=function(e,r){if("string"!=typeof e)throw new Error("first parameter must be a user address");if("function"!=typeof r)throw new Error("second parameter must be a callback");var o=this,s="";s=-1<e.indexOf("://")?e.replace(/ /g,"").split("/")[2]:e.replace(/ /g,"").split("@")[1];var n=0,i="https";function a(){var t="";return e.split("://")[1]||(t="acct:"),i+"://"+s+"/.well-known/"+l[n]+"?resource="+t+e}function t(t){if(o.config.uri_fallback&&"webfist.org"!==s&&n!==l.length-1)return n+=1,u();if(!o.config.tls_only&&"https"===i)return n=0,i="http",u();if(!o.config.webfist_fallback||"webfist.org"===s)return r(t);n=0,i="http",s="webfist.org";var e=a();o.__fetchJRD(e,r,function(t){o.__processJRD(e,t,r,function(t){"object"==typeof t.idx.links.webfist&&"string"==typeof t.idx.links.webfist[0].href&&o.__fetchJRD(t.idx.links.webfist[0].href,r,function(t){o.__processJRD(e,t,r,function(t){return r(null,r)})})})})}function u(){var e=a();o.__fetchJRD(e,t,function(t){o.__processJRD(e,t,r,function(t){r(null,t)})})}return o.__isLocalhost(s)&&(i="http"),setTimeout(u,0)},e.prototype.lookupLink=function(t,o,s){if(!c.hasOwnProperty(o))return s("unsupported rel "+o);this.lookup(t,function(t,e){var r=e.idx.links[o];return t?s(t):0===r.length?s('no links found with rel="'+o+'"'):s(null,r[0])})},"function"==typeof define&&define.amd?define([],function(){return e}):"undefined"!=typeof exports?("undefined"!=typeof module&&module.exports&&(exports=module.exports=e),exports.WebFinger=e):t.WebFinger=e}(this);